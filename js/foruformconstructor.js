"use strict";angular.module("YepCom").directive("foruformconstructor",function($state,Layout,$compile,$timeout,RandomString,Msgservice,toaster,$sce,$rootScope,$sanitize,$window,ForuPolicy,$ocLazyLoad,$injector){return{restrict:"EA",replace:!0,template:'<div class="foruformconstructor" extraname="forublockformconstructor" elementid="elforuformconstructorouter" ng-style="sitecontent.elforuformconstructorouter.style" ng-class="sitecontent.elforuformconstructorouter.classes" ></div>',link:function(scope,element,attrs){scope.validEmail=!0,scope.formFlag=!1,scope.successMsgFlag=!1,scope.showModal=!1,scope.showOverlayModal=!1,scope.forusermodalFlag=!1,scope.showModalReady=!1,scope.defaultValues=[],scope.trustAsHtml=function(string){var res=$sanitize(string);return $sce.trustAsHtml(res)},scope.updateExtraTemplate=function(name){var id=scope.elemdata.extrablock_id.$oid;return Layout.updateTemplate(id,name).then(function(templ){element.html(""),scope.elemdata.templatename=name,scope.elemdata.templatehtml=templ,$compile(templ)(scope,function(newelem){element.html(newelem),scope.disableCheckbox(),scope.initBaseDropZone()})})},$rootScope.$on("showUserModal",function(evt,id){var _ref,_ref1;if(id===(null!=(_ref=scope.sitecontent)&&null!=(_ref1=_ref.forusermodal)?_ref1.id:void 0))return scope.showUserModal();scope.closeUserModal()}),scope.$on("setLayoutelforuformconstructor",function(evt,template,yelemid,classes){var cls;if(null==classes&&(classes=null),yelemid===scope.yeid)return cls=scope.sitecontent.elforuformconstructorouter.classes,classes?-1===cls.indexOf(classes)&&(scope.sitecontent.elforuformconstructorouter.classes=classes):-1===cls.indexOf(template)&&(scope.sitecontent.elforuformconstructorouter.classes=template),scope.updateExtraTemplate(template)}),scope.validateEmail=function(email){return/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(String(email).toLowerCase())},scope.sendMailChimp=function(){var id,item,_i,_len,_ref,_ref1,_ref2,_ref3,_results;if(null!==(null!=(_ref=scope.sitecontent.formconstructor)&&null!=(_ref1=_ref.mailChimp)&&null!=(_ref2=_ref1.currentListItem)?_ref2.id:void 0)){for(id=scope.sitecontent.formconstructor.mailChimp.currentListItem.id,_results=[],_i=0,_len=(_ref3=scope.sitecontent.formconstructor.formItems).length;_i<_len;_i++)"email"===(null!=(item=_ref3[_i])?item.type:void 0)?_results.push(scope.MailChimpService.addEmail(id,item.value).then(function(result){})):_results.push(void 0);return _results}},scope.afterSendForm=function(result,fResult){$("#formconstructorSplash").remove();var _k,_len2,_ref2,_ref3,_ref4,_ref5,_ref6,_ref7;for(scope.successMsgFlag=!0,scope.formFlag=!0,_k=0,_len2=(_ref2=scope.sitecontent.formconstructor.formItems).length;_k<_len2;_k++){var item=_ref2[_k];if("text"===item.type||"textarea"===item.type||"number"===item.type){var index=_.findIndex(scope.defaultValues,function(o){return o.id===item.id});index>-1&&(item.value=null!=(_ref3=scope.defaultValues[index])?_ref3.value:void 0)}else"email"===item.type&&(null!=(_ref4=scope.$parent.$parent.$parent)&&null!=(_ref5=_ref4.userData)?_ref5.email:void 0)?item.value=null!=(_ref6=scope.$parent.$parent.$parent)&&null!=(_ref7=_ref6.userData)?_ref7.email:void 0:item.value=""}$timeout(function(){scope.successMsgFlag=!1},1800),$timeout(function(){scope.formFlag=!1},2200),scope.forusermodalFlag&&$timeout(function(){scope.closeUserModal()},2300)},scope.disableCheckbox=function(){"preview2"!==$state.current.name&&($timeout(function(){$(element).find('input[type="checkbox"]').attr("disabled","disabled")},1e3),scope.$on("changeFoRuFormConstructorInput",function(evt){scope.drawConfigPrivacyBtn(),$timeout(function(){$(element).find('input[type="checkbox"]').attr("disabled","disabled")},1e3)}))},scope.sendFormData=function(){var actions,emailCounter,externalServiceFlag,id,item,requeredFlag,sendData,sendForm,_i,_j,_len,_len1,_ref,_ref1;for(requeredFlag=!0,actions=[],id=scope.sitecontent.formconstructor.mailChimp.currentListItem.id,emailCounter=0,_i=0,_len=(_ref=scope.sitecontent.formconstructor.formItems).length;_i<_len;_i++)(item=_ref[_i]).requered&&0===(null!=(_ref1=item.value)?_ref1.length:void 0)&&"checkbox"!==item.type&&(requeredFlag=!1),item.requered&&!item.value&&"checkbox"===item.type&&(requeredFlag=!1),"email"===item.type&&(scope.validEmail=scope.validateEmail(item.value),emailCounter+=1);if(emailCounter>0&&null!==id&&actions.push({mailchimp:{listid:id}}),"preview2"===$state.current.name)if(requeredFlag){if(scope.validEmail){sendData=_.cloneDeep(scope.sitecontent.formconstructor.formItems),sendForm="",externalServiceFlag=!1;var validUrl=!1;for(scope.sitecontent.formconstructor.hasOwnProperty("enableExternalService")&&scope.sitecontent.formconstructor.hasOwnProperty("externalService")&&scope.sitecontent.formconstructor.enableExternalService&&(scope.sitecontent.formconstructor.externalService.hasOwnProperty("method")||(scope.sitecontent.formconstructor.externalService.method={}),scope.sitecontent.formconstructor.externalService.method.hasOwnProperty("name")||(scope.sitecontent.formconstructor.externalService.method.name="get"),scope.sitecontent.formconstructor.externalService.hasOwnProperty("url")||(scope.sitecontent.formconstructor.externalService.url=""),externalServiceFlag=!0,(validUrl=/(http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/i.test(scope.sitecontent.formconstructor.externalService.url))&&(scope.mywindow=$window.open("","_blank","width=900,height=800"),sendForm="<form id='externalForm' method='"+scope.sitecontent.formconstructor.externalService.method.name+"' action='"+scope.sitecontent.formconstructor.externalService.url+'\' accept-charset="windows-1251"> ')),_j=0,_len1=sendData.length;_j<_len1;_j++)(item=sendData[_j]).label=item.text.replace(/<\/?[^>]+>/gi,""),externalServiceFlag&&(sendForm+="<input type='hidden' name='"+item.externalField+"' value='"+item.value+"'>");externalServiceFlag&&validUrl&&$compile(sendForm+="</form>")(scope,function(newelem){var form;return $(scope.mywindow.document.body).html(newelem),form=$(scope.mywindow.document.body).find("#externalForm"),$timeout(function(){return form.submit()},500)});var contactmails=null;scope.sitecontent.formconstructor.hasOwnProperty("contactmails")&&(contactmails=scope.sitecontent.formconstructor.contactmails);return $compile('<div id="formconstructorSplash" style="position: fixed; top: 0; width: 100%; height: 100vh; background-color: #00000026;"><div class="c-loader c-loader--bricks ng-isolate-scope"><div></div> <div></div> <div></div> </div></div>')(scope,function(newelem){$(element).append(newelem)}),Msgservice.sendForm(sendData,actions,contactmails).then(function(result){scope.fileList&&scope.fileList.length>0?Msgservice.sendfiles(result._id.$oid,scope.fileList).then(function(fResult){scope.fileList=[],scope.afterSendForm(result,fResult)}):scope.afterSendForm(result,null)})}toaster.pop("error","Внимание!","Неправильно указан адрес электронной почты!!")}else toaster.pop("warning","Внимание!","Не все обязательные поля заполнены!")},scope.setForuFormConstructor=function(event){var newElementId,newelem,yelem;return yelem=$("[yelemid="+scope.elemdata.yeid+"]"),scope.$emit("showSettingsEditor",scope,yelem),$timeout(function(){return scope.$emit("openPartSettingFormContrictor")},600),newElementId="input_"+RandomString.generateRandomString(32).toLowerCase(),scope.sitecontent.formconstructor.formItems.push({selectOptions:[],value:"",type:"text",typeObj:{name:"Имя",type:"text"},typeName:"Имя",label:"Заголовок",id:newElementId,placeholder:"Подсказка",requered:!1,text:"Заголовок",classes:"",style:{}}),newelem=scope.sitecontent.formconstructor.formItems[scope.sitecontent.formconstructor.formItems.length-1],scope.sitecontent[newElementId]=newelem},scope.closeUserModal=function(){if(scope.isView)return scope.showModal=!1,scope.showOverlayModal=!1},scope.hideAllUserModal=function(){$rootScope.$emit("showUserModal",null)},scope.showUserModal=function(){scope.hideAllUserModal();var winH,winW;if(scope.showModalReady)return scope.showModal=!0,scope.showOverlayModal=!0,winH=parseInt(0|$(window).height()),winW=parseInt(0|$(window).width()),$timeout(function(){var leftOffset,modalSizes,topOffset;return modalSizes=$(element).find(".foru-user-modal-container")[0].getBoundingClientRect(),(topOffset=parseInt((winH-modalSizes.height)/2))<0&&(topOffset=0),(leftOffset=parseInt((winW-modalSizes.width)/2))<0&&(leftOffset=0),$(element).find(".foru-user-modal-container").css({position:"fixed",top:topOffset+"px",left:leftOffset+"px","z-index":"9999",opacity:"1"})},300)},scope.init=function(){var item,key,keys,templ,_i,_j,_k,_len,_len1,_len2,_ref,_ref1,_ref2,_ref3,_ref4;if((null!=(_ref=scope.sitecontent)?_ref.formconstructor:void 0)||(scope.sitecontent.formconstructor={}),(null!=(_ref1=scope.sitecontent.formconstructor)?_ref1.formId:void 0)||null!=(_ref2=scope.sitecontent)&&(_ref2.formconstructor.formId="form_"+RandomString.generateRandomString(32).toLowerCase()),(null!=(_ref3=scope.sitecontent.formconstructor)?_ref3.formItems:void 0)||(scope.sitecontent.formconstructor.formItems=[]),scope.sitecontent.formconstructor.formItems&&(scope.defaultValues=_.cloneDeep(scope.sitecontent.formconstructor.formItems),scope.sitecontent.formconstructor.formItems.length>0))for(_i=0,_len=(_ref4=scope.sitecontent.formconstructor.formItems).length;_i<_len;_i++)(item=_ref4[_i]).text||(item.text=item.label),scope.sitecontent[item.id]=item,scope.sitecontent[item.id].text||(scope.sitecontent[item.id].text=""),scope.sitecontent[item.id].style||(scope.sitecontent[item.id].style={}),scope.sitecontent[item.id].classes||(scope.sitecontent[item.id].classes=""),"text"===item.type||"textarea"===item.type||"number"===item.type?scope.sitecontent[item.id].value=item.value:scope.sitecontent[item.id].value="";if(scope.isView=!1,"preview2"===$state.current.name||"localpreview"===$state.current.name||"templatepreview"===$state.current.name||"previewimage"===$state.current.name){for(scope.isView=!0,$timeout(function(){$(element).find(".formpolicylink").on("click",function(event){ForuPolicy.checkPolicy().then(function(res){if(res){var openlink=window.origin+"/foru-privacy/privacy";window.open(openlink,"_blank").focus()}else window.open("https://fo.ru/blog/politika-konfidentsialnosti/","_blank").focus()})})},3e3),scope.sitecontent.formconstructor.formItems.push({classes:"check_class",id:"input_confirm",label:"",placeholder:"",requered:!0,style:{},text:'<span style="line-height: 1.3;" class="agreetext"><span>Я соглашаюсь с</span> <span class="c-link formpolicylink" > политикой обработки персональных данных</span></span>',type:"checkbox",typeName:"Подтверждение о согласии с политикой обработки персональных данных",typeObj:{name:"Подтверждение о согласии с политикой обработки персональных данных",type:"checkbox",value:!1}}),templ=scope.elemdata.templatehtml.replace(/\&\#39\;/g,"'"),_j=0,_len1=(keys=Object.keys(scope.sitecontent)).length;_j<_len1;_j++)key=keys[_j],scope.sitecontent[key]&&scope.sitecontent[key].text&&(templ=templ.replace("ng-model=\"sitecontent['"+key+"']['text']\"","ng-bind-html=\"trustAsHtml(sitecontent['"+key+"']['text'])\"")),"forusermodal"===key&&(scope.forusermodalFlag=!0);if($compile(templ)(scope,function(newelem){return $timeout(function(){$(".check_class").closest(".checkbox").addClass("politicscheckbox"),scope.initBaseDropZone()},300),element.html(newelem)}),scope.forusermodalFlag)return scope.$on("loadedBlock",function(){if(scope.showModal=!1,scope.showOverlayModal=!1,scope.showModalReady=!0,$(element).attr("data-foru-user-modal-id",scope.sitecontent.forusermodal.id),scope.sitecontent.forusermodal.hasOwnProperty("timer")&&scope.sitecontent.forusermodal.timer.enable&&scope.sitecontent.forusermodal.timer.hasOwnProperty("value"))return $timeout(function(){return scope.showUserModal()},scope.sitecontent.forusermodal.timer.value.time)})}else{for(scope.showModal=!0,scope.showOverlayModal=!1,_k=0,_len2=(keys=Object.keys(scope.sitecontent)).length;_k<_len2;_k++)"forusermodal"===(key=keys[_k])&&(scope.sitecontent[key].hasOwnProperty("id")||(scope.sitecontent[key].id="userModal_"+RandomString.generateRandomString(32).toLowerCase()),$(element).attr("data-foru-user-modal-id",scope.sitecontent.forusermodal.id),scope.sitecontent[key].hasOwnProperty("name")||(scope.sitecontent[key].name=$("[data-foru-user-modal-id]").length),$(element).attr("data-foru-user-modal-name",scope.sitecontent.forusermodal.name),$(element).css("position","static"),$timeout(function(pass){return $(element).prepend("<h2 class='foru-user-modal-title'>Всплывающее окно "+pass+"</h2> <div class='foru-user-modal-description'>В опубликованной версии сайта это окно будет появляться по нажатию на кнопку или по таймеру</div>"),$(element).css("margin-bottom","32px")},2e3,!0,scope.sitecontent[key].name));scope.elemdata&&scope.elemdata.templatename&&(scope.updateExtraTemplate(scope.elemdata.templatename),scope.sitecontent.formconstructor.template=scope.elemdata.templatename,scope.rebuildsitecontent(),scope.tojsoncontent(),scope.formId=scope.sitecontent.formconstructor.formId),$timeout(function(){scope.drawConfigPrivacyBtn()},9e3)}},scope.fileList=[],scope.openFileSelect=function(itemId){var btnId="#"+itemId+"_fileinput";$(btnId).trigger("click"),$(btnId).off("change").on("change",function(event){for(var i=0;i<event.target.files.length;i++)scope.fileList.push(event.target.files[i])})},scope.drawConfigPrivacyBtn=function(){$(element).find(".privacy-input-form").remove(),$timeout(function(){$compile('            <div class="privacy-input-form">              <div class="checkbox politicscheckbox">                <label >                  <input ng-model="item.value" style="margin-top: 3px;" title="" type="checkbox">                  <span elementid="input_confirm" class="check_class">                    <span style="line-height: 1.3; font-size: 14px;" class="agreetext">                      Я  соглашаюсь с <span class="c-link">политикой обработки персональных данных</span>                    </span>                  </span>                  <sup style="color: red" title="Обязательное для заполнения поле" >*</sup>                </label>              </div>              <div style="text-align: right;"><span class="f-btn c-link c-link--sky-blue" ng-click="configPrivacy($event)">Настроить</span></div>            </div>')(scope,function(newelem){var items=$(element).find(".form-group[data-formconstructor-item]");items&&items.length>0&&$(items[items.length-1]).after(newelem)})},300)},scope.removeFileItem=function(index){scope.fileList.splice(index,1)},scope.configPrivacy=function(event){event.preventDefault(),event.stopPropagation(),window.open("https://privacy.fo.ru/","_blank").focus()},$ocLazyLoad.load({cache:!0},{name:"mailchimp FormEditor",files:["/assets/js/services/mailchimp.js?"+(window.yepbuildversion||Math.floor(1e8*Math.random()))]}).then(function(){scope.MailChimpService=$injector.get("MailChimpService"),scope.init()})}}});